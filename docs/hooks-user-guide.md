# Claude Hooks ユーザーガイド

Claude hooksの処理タイミングと実用的な使用例を解説します。

## Hook処理の全体フロー

```
ユーザー入力
    ↓
[UserPromptSubmit] ← プロンプトのフィルタリング・拡張
    ↓
Claude処理開始
    ↓
（必要に応じて）
[PreCompact] ← コンテキスト圧縮前の処理
    ↓
（ツール使用が必要な場合）
    ↓
（許可が必要なツールの場合）
[Notification] ← ツール許可要求
    ↓
[PreToolUse] ← ツール実行前の許可/拒否
    ↓
ツール実行
    ↓
[PostToolUse] ← ツール実行後のログ・検証
    ↓
[Stop/SubagentStop] ← 応答完了時の処理（ユーザー中断時は発生しない）
    ↓
（60秒経過した場合）
[Notification] ← アイドル通知
```

## 各Hookの詳細と使用例

### 1. UserPromptSubmit

**タイミング**: ユーザーがプロンプトを送信した直後、Claudeが処理を開始する前

**主な用途**:

- セキュリティフィルタリング
- コンテキストの自動追加
- プロンプトの前処理

**実用例**:

- APIキーやパスワードなどの機密情報を含むプロンプトをブロック
- すべてのプロンプトにプロジェクトルール（使用言語、パッケージマネージャーなど）を自動追加
- 「本番環境のデータを削除して」などの危険な要求をブロック
- 曖昧なプロンプトに現在のブランチ名や変更内容を自動補完

### 2. PreToolUse

**タイミング**: Claudeがツールを実行しようとする直前

**主な用途**:

- 危険な操作のブロック（破壊的コマンド、機密ファイルへのアクセス）
- 安全な操作の自動承認（読み取り専用コマンドなど）
- 代替手段への誘導（より適切なツールの使用を促す）

**実用例**:

- `.env`ファイルへの編集操作をブロック
- `rm -rf /`などの破壊的コマンドの実行を防止
- `ls`や`pwd`などの安全な読み取り専用コマンドを自動承認
- GitHub APIへの`curl`をブロックし、`gh`コマンドの使用を促す

### 3. PostToolUse

**タイミング**: ツールの実行が完了した後

**主な用途**:

- 実行結果の記録（tool_responseで結果を取得）
- エラー検出とClaudeへの指示

**実用例**:

- ファイル編集操作をログに記録
- Bashコマンドの終了コード（exitCode）でテスト失敗を検出し、Claudeに修正を指示
- 標準エラー出力（stderr）からビルドエラーを検出してClaudeに報告
- コマンドの実行結果を監査ログとして保存

### 4. Notification

**タイミング**:

- Claudeがツール使用の許可を求めるとき
- Claudeがタスク完了後60秒以上ユーザー入力を待っているとき

**主な用途**:

- ツール許可要求の検出
- アイドル状態の検出

**実用例**:

- ツール許可要求時にユーザーに通知
- 60秒アイドル時にユーザーに通知

### 5. Stop / SubagentStop

**タイミング**:

- Stop: メインエージェントが応答を完了したとき（ユーザー中断時は発生しない）
- SubagentStop: サブエージェントが応答を完了したとき

**主な用途**:

- 応答完了を条件付きでブロック
- 応答完了時の通知や記録
- 未完了タスクの確認

**実用例**:

- 未コミットの変更がある場合はClaudeに続けさせる
- テストが失敗している場合は修正を促す
- 応答完了時にユーザーに通知

### 6. PreCompact

**タイミング**: コンテキストが圧縮される前

**主な用途**:

- 手動圧縮（`/compact`）と自動圧縮の区別
- 圧縮前のカスタム処理
- 圧縮の監視と記録

**実用例**:

- 自動圧縮時にユーザーに通知
- 手動圧縮と自動圧縮を区別して記録
